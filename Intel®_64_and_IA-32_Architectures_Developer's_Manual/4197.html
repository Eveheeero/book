<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p4197" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_4197{left:776px;bottom:68px;letter-spacing:0.1px;word-spacing:-0.1px;}
#t2_4197{left:820px;bottom:68px;letter-spacing:0.12px;}
#t3_4197{left:697px;bottom:1141px;letter-spacing:-0.14px;}
#t4_4197{left:70px;bottom:1088px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#t5_4197{left:70px;bottom:1071px;letter-spacing:-0.17px;word-spacing:-0.42px;}
#t6_4197{left:70px;bottom:1054px;letter-spacing:-0.15px;word-spacing:-0.76px;}
#t7_4197{left:70px;bottom:1037px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t8_4197{left:70px;bottom:1020px;letter-spacing:-0.17px;word-spacing:-0.45px;}
#t9_4197{left:70px;bottom:1004px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#ta_4197{left:70px;bottom:981px;letter-spacing:-0.14px;word-spacing:-0.59px;}
#tb_4197{left:70px;bottom:964px;letter-spacing:-0.18px;word-spacing:-0.68px;}
#tc_4197{left:70px;bottom:947px;letter-spacing:-0.16px;word-spacing:-0.46px;}
#td_4197{left:70px;bottom:930px;letter-spacing:-0.19px;word-spacing:-0.43px;}
#te_4197{left:70px;bottom:914px;letter-spacing:-0.23px;word-spacing:-0.91px;}
#tf_4197{left:70px;bottom:897px;letter-spacing:-0.16px;word-spacing:-0.45px;}
#tg_4197{left:70px;bottom:880px;letter-spacing:-0.15px;word-spacing:-0.48px;}
#th_4197{left:70px;bottom:863px;letter-spacing:-0.17px;word-spacing:-0.78px;}
#ti_4197{left:70px;bottom:846px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#tj_4197{left:70px;bottom:788px;letter-spacing:0.13px;}
#tk_4197{left:152px;bottom:788px;letter-spacing:0.15px;word-spacing:-0.04px;}
#tl_4197{left:70px;bottom:765px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tm_4197{left:70px;bottom:749px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tn_4197{left:70px;bottom:732px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#to_4197{left:70px;bottom:715px;letter-spacing:-0.16px;}
#tp_4197{left:70px;bottom:692px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tq_4197{left:70px;bottom:675px;letter-spacing:-0.14px;word-spacing:-0.5px;}
#tr_4197{left:70px;bottom:658px;letter-spacing:-0.13px;word-spacing:-0.51px;}
#ts_4197{left:70px;bottom:635px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#tt_4197{left:70px;bottom:619px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#tu_4197{left:70px;bottom:602px;letter-spacing:-0.18px;word-spacing:-0.77px;}
#tv_4197{left:70px;bottom:585px;letter-spacing:-0.15px;word-spacing:-1.19px;}
#tw_4197{left:70px;bottom:568px;letter-spacing:-0.17px;word-spacing:-1.19px;}
#tx_4197{left:70px;bottom:551px;letter-spacing:-0.19px;word-spacing:-0.42px;}
#ty_4197{left:70px;bottom:501px;letter-spacing:-0.09px;}
#tz_4197{left:156px;bottom:501px;letter-spacing:-0.11px;word-spacing:-0.01px;}
#t10_4197{left:70px;bottom:479px;letter-spacing:-0.16px;word-spacing:-0.45px;}
#t11_4197{left:70px;bottom:462px;letter-spacing:-0.17px;word-spacing:-0.45px;}
#t12_4197{left:70px;bottom:445px;letter-spacing:-0.25px;word-spacing:-0.37px;}
#t13_4197{left:70px;bottom:428px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#t14_4197{left:70px;bottom:405px;letter-spacing:-0.18px;word-spacing:-0.44px;}
#t15_4197{left:70px;bottom:389px;letter-spacing:-0.23px;word-spacing:-0.38px;}
#t16_4197{left:70px;bottom:372px;letter-spacing:-0.16px;}
#t17_4197{left:70px;bottom:322px;letter-spacing:-0.09px;}
#t18_4197{left:156px;bottom:322px;letter-spacing:-0.11px;}
#t19_4197{left:70px;bottom:299px;letter-spacing:-0.15px;word-spacing:-0.47px;}
#t1a_4197{left:70px;bottom:283px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#t1b_4197{left:70px;bottom:266px;letter-spacing:-0.15px;word-spacing:-1.1px;}
#t1c_4197{left:70px;bottom:249px;letter-spacing:-0.15px;word-spacing:-0.97px;}
#t1d_4197{left:70px;bottom:232px;letter-spacing:-0.15px;word-spacing:-1.35px;}
#t1e_4197{left:70px;bottom:215px;letter-spacing:-0.2px;}
#t1f_4197{left:70px;bottom:192px;letter-spacing:-0.15px;word-spacing:-1.17px;}
#t1g_4197{left:70px;bottom:176px;letter-spacing:-0.17px;word-spacing:-0.94px;}
#t1h_4197{left:70px;bottom:159px;letter-spacing:-0.16px;word-spacing:-0.44px;}

.s1_4197{font-size:12px;font-family:NeoSansIntel_6wv3;color:#000;}
.s2_4197{font-size:14px;font-family:NeoSansIntel_6wv3;color:#0860A8;}
.s3_4197{font-size:14px;font-family:Verdana_b5t;color:#000;}
.s4_4197{font-size:18px;font-family:NeoSansIntelMedium_6wv2;color:#0860A8;}
.s5_4197{font-size:17px;font-family:NeoSansIntelMedium_6wv2;color:#0860A8;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts4197" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_6wv2;
	src: url("fonts/NeoSansIntelMedium_6wv2.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_6wv3;
	src: url("fonts/NeoSansIntel_6wv3.woff") format("woff");
}

@font-face {
	font-family: Verdana_b5t;
	src: url("fonts/Verdana_b5t.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg4197Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg4197" style="-webkit-user-select: none;"><object width="935" height="1210" data="4197/4197.svg" type="image/svg+xml" id="pdf4197" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_4197" class="t s1_4197">Vol. 3C </span><span id="t2_4197" class="t s1_4197">33-35 </span>
<span id="t3_4197" class="t s2_4197">INTEL® PROCESSOR TRACE </span>
<span id="t4_4197" class="t s3_4197">A PSB+ can be lost in some scenarios. If IA32_RTIT_STATUS.TriggerEn is cleared just as the PSB threshold is </span>
<span id="t5_4197" class="t s3_4197">reached, e.g., due to TraceEn being cleared, the PSB+ may not be generated. On processors that support PSB </span>
<span id="t6_4197" class="t s3_4197">preservation (CPUID.(EAX=14H, ECX=0):EBX[bit 6] = 1), setting IA32_RTIT_CTL.InjectPsbPmiOnEnable[56] = 1 </span>
<span id="t7_4197" class="t s3_4197">will ensure that a PSB+ that is pending at the time PT is disabled will be recorded by setting </span>
<span id="t8_4197" class="t s3_4197">IA32_RTIT_STATUS.PendPSB[6] = 1. A PSB will be inserted, and PendPSB cleared, when PT is later re-enabled </span>
<span id="t9_4197" class="t s3_4197">while PendPSB = 1. </span>
<span id="ta_4197" class="t s3_4197">Note that an overflow can occur during PSB+, and this could cause the PSBEND packet to be lost. For this reason, </span>
<span id="tb_4197" class="t s3_4197">the OVF packet should also be viewed as terminating PSB+. If IA32_RTIT_STATUS.TriggerEn is cleared just as the </span>
<span id="tc_4197" class="t s3_4197">PSB threshold is reached, the PSB+ may not be generated. TriggerEn can be cleared by a WRMSR that clears </span>
<span id="td_4197" class="t s3_4197">IA32_RTIT_CTL.TraceEn, a VM exit that clears IA32_RTIT_CTL.TraceEn, an #SMI, or any time that either </span>
<span id="te_4197" class="t s3_4197">IA32_RTIT_STATUS.Stopped is set (e.g., by a TraceStop or ToPA stop condition) or IA32_RTIT_STATUS.Error is set </span>
<span id="tf_4197" class="t s3_4197">(e.g., by an Intel PT output error). On processors that support PSB preservation (CPUID.(EAX=14H, </span>
<span id="tg_4197" class="t s3_4197">ECX=0):EBX[bit 6] = 1), setting IA32_RTIT_CTL.InjectPsbPmiOnEnable[56] = 1 will ensure that a PSB+ that is </span>
<span id="th_4197" class="t s3_4197">pending at the time PT is disabled will be recorded by setting IA32_RTIT_STATUS.PendPSB[6] = 1. A PSB will then </span>
<span id="ti_4197" class="t s3_4197">be pended when the saved PT context is later restored. </span>
<span id="tj_4197" class="t s4_4197">33.3.8 </span><span id="tk_4197" class="t s4_4197">Internal Buffer Overflow </span>
<span id="tl_4197" class="t s3_4197">In the rare circumstances when new packets need to be generated but the processor’s dedicated internal buffers </span>
<span id="tm_4197" class="t s3_4197">are all full, an “internal buffer overflow” occurs. On such an overflow packet generation ceases (as packets would </span>
<span id="tn_4197" class="t s3_4197">need to enter the processor’s internal buffer) until the overflow resolves. Once resolved, packet generation </span>
<span id="to_4197" class="t s3_4197">resumes. </span>
<span id="tp_4197" class="t s3_4197">When the buffer overflow is cleared, an OVF packet (Section 33.4.2.16) is generated, and the processor ensures </span>
<span id="tq_4197" class="t s3_4197">that packets which follow the OVF are not compressed (IP compression or RET compression) against packets that </span>
<span id="tr_4197" class="t s3_4197">were lost. </span>
<span id="ts_4197" class="t s3_4197">If IA32_RTIT_CTL.BranchEn = 1, the OVF packet will be followed by a FUP if the overflow resolves while Pack- </span>
<span id="tt_4197" class="t s3_4197">etEn=1. If the overflow resolves while PacketEn = 0 no packet is generated, but a TIP.PGE will naturally be gener- </span>
<span id="tu_4197" class="t s3_4197">ated later, once PacketEn = 1. The payload of the FUP or TIP.PGE will be the Current IP of the first instruction upon </span>
<span id="tv_4197" class="t s3_4197">which tracing resumes after the overflow is cleared. If the overflow resolves while PacketEn=1, only timing packets </span>
<span id="tw_4197" class="t s3_4197">may come between the OVF and the FUP. If the overflow resolves while PacketEn=0, any other packets that are not </span>
<span id="tx_4197" class="t s3_4197">dependent on PacketEn may come between the OVF and the TIP.PGE. </span>
<span id="ty_4197" class="t s5_4197">33.3.8.1 </span><span id="tz_4197" class="t s5_4197">Overflow Impact on Enables </span>
<span id="t10_4197" class="t s3_4197">The address comparisons to ADDRn ranges, for IP filtering and TraceStop (Section 33.2.5.3), continue during a </span>
<span id="t11_4197" class="t s3_4197">buffer overflow, and TriggerEn, ContextEn, and FilterEn may change during a buffer overflow. Like other packets, </span>
<span id="t12_4197" class="t s3_4197">however, any TIP.PGE or TIP.PGD packets that would have been generated will be lost. Further, </span>
<span id="t13_4197" class="t s3_4197">IA32_RTIT_STATUS.PacketByteCnt will not increment, since it is only incremented when packets are generated. </span>
<span id="t14_4197" class="t s3_4197">If a TraceStop event occurs during the buffer overflow, IA32_RTIT_STATUS.Stopped will still be set, tracing will </span>
<span id="t15_4197" class="t s3_4197">cease as a result. However, the TraceStop packet, and any TIP.PGD that result from the TraceStop, may be </span>
<span id="t16_4197" class="t s3_4197">dropped. </span>
<span id="t17_4197" class="t s5_4197">33.3.8.2 </span><span id="t18_4197" class="t s5_4197">Overflow Impact on Timing Packets </span>
<span id="t19_4197" class="t s3_4197">Any timing packets that are generated during a buffer overflow will be dropped. If only a few MTC packets are </span>
<span id="t1a_4197" class="t s3_4197">dropped, a decoder should be able to detect this by noticing that the time value in the first MTC packet after the </span>
<span id="t1b_4197" class="t s3_4197">buffer overflow incremented by more than one. If the buffer overflow lasted long enough that 256 MTC packets are </span>
<span id="t1c_4197" class="t s3_4197">lost (and thus the MTC packet ‘wraps’ its 8-bit CTC value), then the decoder may be unable to properly understand </span>
<span id="t1d_4197" class="t s3_4197">the trace. This is not an expected scenario. No CYC packets are generated during overflow, even if the cycle counter </span>
<span id="t1e_4197" class="t s3_4197">wraps. </span>
<span id="t1f_4197" class="t s3_4197">Note that, if cycle-accurate mode is enabled, the OVF packet will generate a CYC packet. Because the cycle counter </span>
<span id="t1g_4197" class="t s3_4197">counts during overflows, this CYC packet can provide the duration of the overflow. However, there is a risk that the </span>
<span id="t1h_4197" class="t s3_4197">cycle counter wrapped during the overflow, which could render this CYC misleading. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
