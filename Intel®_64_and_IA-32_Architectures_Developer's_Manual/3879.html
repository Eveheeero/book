<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p3879" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_3879{left:775px;bottom:68px;letter-spacing:0.1px;}
#t2_3879{left:820px;bottom:68px;letter-spacing:0.12px;}
#t3_3879{left:747px;bottom:1141px;letter-spacing:-0.14px;}
#t4_3879{left:70px;bottom:1083px;letter-spacing:0.13px;}
#t5_3879{left:152px;bottom:1083px;letter-spacing:0.15px;word-spacing:0.01px;}
#t6_3879{left:152px;bottom:1061px;letter-spacing:0.15px;word-spacing:0.01px;}
#t7_3879{left:70px;bottom:1037px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#t8_3879{left:70px;bottom:1020px;letter-spacing:-0.14px;word-spacing:-0.63px;}
#t9_3879{left:70px;bottom:1004px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#ta_3879{left:70px;bottom:979px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tb_3879{left:70px;bottom:962px;letter-spacing:-0.14px;word-spacing:-0.44px;}
#tc_3879{left:70px;bottom:936px;}
#td_3879{left:96px;bottom:940px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#te_3879{left:70px;bottom:913px;}
#tf_3879{left:96px;bottom:917px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#tg_3879{left:70px;bottom:892px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#th_3879{left:70px;bottom:875px;letter-spacing:-0.15px;word-spacing:-1.07px;}
#ti_3879{left:70px;bottom:859px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#tj_3879{left:70px;bottom:842px;letter-spacing:-0.18px;word-spacing:-0.41px;}
#tk_3879{left:441px;bottom:802px;letter-spacing:-0.13px;}
#tl_3879{left:124px;bottom:781px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tm_3879{left:124px;bottom:764px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tn_3879{left:124px;bottom:747px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#to_3879{left:124px;bottom:730px;letter-spacing:-0.13px;word-spacing:-1px;}
#tp_3879{left:124px;bottom:713px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tq_3879{left:70px;bottom:668px;letter-spacing:-0.14px;word-spacing:-0.85px;}
#tr_3879{left:70px;bottom:651px;letter-spacing:-0.14px;word-spacing:-0.61px;}
#ts_3879{left:70px;bottom:634px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tt_3879{left:70px;bottom:617px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#tu_3879{left:70px;bottom:600px;letter-spacing:-0.15px;word-spacing:-0.47px;}
#tv_3879{left:70px;bottom:584px;letter-spacing:-0.15px;word-spacing:-0.48px;}
#tw_3879{left:70px;bottom:567px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tx_3879{left:70px;bottom:542px;letter-spacing:-0.14px;word-spacing:-0.87px;}
#ty_3879{left:70px;bottom:525px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tz_3879{left:70px;bottom:509px;letter-spacing:-0.14px;word-spacing:-1.07px;}
#t10_3879{left:70px;bottom:492px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t11_3879{left:70px;bottom:475px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t12_3879{left:70px;bottom:458px;letter-spacing:-0.14px;word-spacing:-0.82px;}
#t13_3879{left:70px;bottom:441px;letter-spacing:-0.15px;word-spacing:-1.28px;}
#t14_3879{left:70px;bottom:425px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t15_3879{left:70px;bottom:408px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t16_3879{left:70px;bottom:383px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t17_3879{left:70px;bottom:367px;letter-spacing:-0.13px;word-spacing:-0.55px;}
#t18_3879{left:70px;bottom:350px;letter-spacing:-0.15px;}
#t19_3879{left:70px;bottom:325px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#t1a_3879{left:70px;bottom:309px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t1b_3879{left:70px;bottom:292px;letter-spacing:-0.15px;word-spacing:-0.5px;}
#t1c_3879{left:70px;bottom:267px;letter-spacing:-0.14px;}
#t1d_3879{left:96px;bottom:267px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t1e_3879{left:96px;bottom:250px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t1f_3879{left:96px;bottom:234px;letter-spacing:-0.15px;word-spacing:-0.6px;}
#t1g_3879{left:96px;bottom:217px;letter-spacing:-0.15px;}
#t1h_3879{left:96px;bottom:192px;letter-spacing:-0.14px;}
#t1i_3879{left:122px;bottom:192px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t1j_3879{left:96px;bottom:168px;letter-spacing:-0.26px;}
#t1k_3879{left:122px;bottom:168px;letter-spacing:-0.19px;word-spacing:-0.69px;}
#t1l_3879{left:122px;bottom:151px;letter-spacing:-0.15px;word-spacing:-0.44px;}
#t1m_3879{left:96px;bottom:127px;letter-spacing:-0.11px;}
#t1n_3879{left:122px;bottom:127px;letter-spacing:-0.13px;word-spacing:-0.49px;}

.s1_3879{font-size:12px;font-family:NeoSansIntel_6wv3;color:#000;}
.s2_3879{font-size:14px;font-family:NeoSansIntel_6wv3;color:#0860A8;}
.s3_3879{font-size:18px;font-family:NeoSansIntelMedium_6wv2;color:#0860A8;}
.s4_3879{font-size:14px;font-family:Verdana_b5t;color:#000;}
.s5_3879{font-size:21px;font-family:TimesNewRoman_b5y;color:#000;}
.s6_3879{font-size:17px;font-family:NeoSansIntelMedium_6wv2;color:#0860A8;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts3879" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_6wv2;
	src: url("fonts/NeoSansIntelMedium_6wv2.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_6wv3;
	src: url("fonts/NeoSansIntel_6wv3.woff") format("woff");
}

@font-face {
	font-family: TimesNewRoman_b5y;
	src: url("fonts/TimesNewRoman_b5y.woff") format("woff");
}

@font-face {
	font-family: Verdana_b5t;
	src: url("fonts/Verdana_b5t.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg3879Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg3879" style="-webkit-user-select: none;"><object width="935" height="1210" data="3879/3879.svg" type="image/svg+xml" id="pdf3879" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_3879" class="t s1_3879">Vol. 3B </span><span id="t2_3879" class="t s1_3879">21-15 </span>
<span id="t3_3879" class="t s2_3879">8086 EMULATION </span>
<span id="t4_3879" class="t s3_3879">21.3.2 </span><span id="t5_3879" class="t s3_3879">Class 2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the </span>
<span id="t6_3879" class="t s3_3879">Virtual Interrupt Mechanism </span>
<span id="t7_3879" class="t s4_3879">Maskable hardware interrupts are those interrupts that are delivered through the INTR# pin or through an inter- </span>
<span id="t8_3879" class="t s4_3879">rupt request to the local APIC (see Section 6.3.2, “Maskable Hardware Interrupts”). These interrupts can be inhib- </span>
<span id="t9_3879" class="t s4_3879">ited (masked) from interrupting an executing program or task by clearing the IF flag in the EFLAGS register. </span>
<span id="ta_3879" class="t s4_3879">When the VME flag in control register CR4 is set and the IOPL field in the EFLAGS register is less than 3, two addi- </span>
<span id="tb_3879" class="t s4_3879">tional flags are activated in the EFLAGS register: </span>
<span id="tc_3879" class="t s5_3879">• </span><span id="td_3879" class="t s4_3879">VIF (virtual interrupt) flag, bit 19 of the EFLAGS register. </span>
<span id="te_3879" class="t s5_3879">• </span><span id="tf_3879" class="t s4_3879">VIP (virtual interrupt pending) flag, bit 20 of the EFLAGS register. </span>
<span id="tg_3879" class="t s4_3879">These flags provide the virtual-8086 monitor with more efficient control over handling maskable hardware inter- </span>
<span id="th_3879" class="t s4_3879">rupts that occur during virtual-8086 mode tasks. They also reduce interrupt-handling overhead, by eliminating the </span>
<span id="ti_3879" class="t s4_3879">need for all IF related operations (such as PUSHF, POPF, CLI, and STI instructions) to trap to the virtual-8086 </span>
<span id="tj_3879" class="t s4_3879">monitor. The purpose and use of these flags are as follows. </span>
<span id="tk_3879" class="t s6_3879">NOTE </span>
<span id="tl_3879" class="t s4_3879">The VIF and VIP flags are only available in IA-32 processors that support the virtual mode </span>
<span id="tm_3879" class="t s4_3879">extensions. These extensions were introduced in the IA-32 architecture with the Pentium </span>
<span id="tn_3879" class="t s4_3879">processor. When this mechanism is either not available or not enabled, maskable hardware </span>
<span id="to_3879" class="t s4_3879">interrupts are handled as class 1 interrupts. Here, if VIF and VIP flags are needed, the virtual-8086 </span>
<span id="tp_3879" class="t s4_3879">monitor can implement them in software. </span>
<span id="tq_3879" class="t s4_3879">Existing 8086 programs commonly set and clear the IF flag in the EFLAGS register to enable and disable maskable </span>
<span id="tr_3879" class="t s4_3879">hardware interrupts, respectively; for example, to disable interrupts while handling another interrupt or an excep- </span>
<span id="ts_3879" class="t s4_3879">tion. This practice works well in single task environments, but can cause problems in multitasking and multiple- </span>
<span id="tt_3879" class="t s4_3879">processor environments, where it is often desirable to prevent an application program from having direct control </span>
<span id="tu_3879" class="t s4_3879">over the handling of hardware interrupts. When using earlier IA-32 processors, this problem was often solved by </span>
<span id="tv_3879" class="t s4_3879">creating a virtual IF flag in software. The IA-32 processors (beginning with the Pentium processor) provide hard- </span>
<span id="tw_3879" class="t s4_3879">ware support for this virtual IF flag through the VIF and VIP flags. </span>
<span id="tx_3879" class="t s4_3879">The VIF flag is a virtualized version of the IF flag, which an application program running from within a virtual-8086 </span>
<span id="ty_3879" class="t s4_3879">task can used to control the handling of maskable hardware interrupts. When the VIF flag is enabled, the CLI and </span>
<span id="tz_3879" class="t s4_3879">STI instructions operate on the VIF flag instead of the IF flag. When an 8086 program executes the CLI instruction, </span>
<span id="t10_3879" class="t s4_3879">the processor clears the VIF flag to request that the virtual-8086 monitor inhibit maskable hardware interrupts </span>
<span id="t11_3879" class="t s4_3879">from interrupting program execution; when it executes the STI instruction, the processor sets the VIF flag </span>
<span id="t12_3879" class="t s4_3879">requesting that the virtual-8086 monitor enable maskable hardware interrupts for the 8086 program. But actually </span>
<span id="t13_3879" class="t s4_3879">the IF flag, managed by the operating system, always controls whether maskable hardware interrupts are enabled. </span>
<span id="t14_3879" class="t s4_3879">Also, if under these circumstances an 8086 program tries to read or change the IF flag using the PUSHF or POPF </span>
<span id="t15_3879" class="t s4_3879">instructions, the processor will change the VIF flag instead, leaving IF unchanged. </span>
<span id="t16_3879" class="t s4_3879">The VIP flag provides software a means of recording the existence of a deferred (or pending) maskable hardware </span>
<span id="t17_3879" class="t s4_3879">interrupt. This flag is read by the processor but never explicitly written by the processor; it can only be written by </span>
<span id="t18_3879" class="t s4_3879">software. </span>
<span id="t19_3879" class="t s4_3879">If the IF flag is set and the VIF and VIP flags are enabled, and the processor receives a maskable hardware inter- </span>
<span id="t1a_3879" class="t s4_3879">rupt (interrupt vector 0 through 255), the processor performs and the interrupt handler software should perform </span>
<span id="t1b_3879" class="t s4_3879">the following operations: </span>
<span id="t1c_3879" class="t s4_3879">1. </span><span id="t1d_3879" class="t s4_3879">The processor invokes the protected-mode interrupt handler for the interrupt received, as described in the </span>
<span id="t1e_3879" class="t s4_3879">following steps. These steps are almost identical to those described for method 1 interrupt and exception </span>
<span id="t1f_3879" class="t s4_3879">handling in Section 21.3.1.1, “Handling an Interrupt or Exception Through a Protected-Mode Trap or Interrupt </span>
<span id="t1g_3879" class="t s4_3879">Gate”: </span>
<span id="t1h_3879" class="t s4_3879">a. </span><span id="t1i_3879" class="t s4_3879">Switches to 32-bit protected mode and privilege level 0. </span>
<span id="t1j_3879" class="t s4_3879">b. </span><span id="t1k_3879" class="t s4_3879">Saves the state of the processor on the privilege-level 0 stack. The states of the EIP, CS, EFLAGS, ESP, SS, </span>
<span id="t1l_3879" class="t s4_3879">ES, DS, FS, and GS registers are saved (see Figure 21-4). </span>
<span id="t1m_3879" class="t s4_3879">c. </span><span id="t1n_3879" class="t s4_3879">Clears the segment registers. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
