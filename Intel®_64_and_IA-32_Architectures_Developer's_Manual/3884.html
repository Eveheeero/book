<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p3884" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_3884{left:69px;bottom:68px;letter-spacing:0.12px;}
#t2_3884{left:110px;bottom:68px;letter-spacing:0.1px;}
#t3_3884{left:69px;bottom:1141px;letter-spacing:-0.15px;word-spacing:0.01px;}
#t4_3884{left:69px;bottom:1088px;letter-spacing:-0.14px;word-spacing:-0.59px;}
#t5_3884{left:69px;bottom:1071px;letter-spacing:-0.14px;word-spacing:-0.42px;}
#t6_3884{left:69px;bottom:1054px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t7_3884{left:69px;bottom:1037px;letter-spacing:-0.14px;word-spacing:-1.18px;}
#t8_3884{left:69px;bottom:1020px;letter-spacing:-0.14px;word-spacing:-0.68px;}
#t9_3884{left:69px;bottom:1004px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#ta_3884{left:69px;bottom:987px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#tb_3884{left:69px;bottom:919px;letter-spacing:0.15px;}
#tc_3884{left:150px;bottom:919px;letter-spacing:0.21px;word-spacing:0.02px;}
#td_3884{left:69px;bottom:894px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#te_3884{left:69px;bottom:877px;letter-spacing:-0.15px;word-spacing:-1.38px;}
#tf_3884{left:69px;bottom:860px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#tg_3884{left:69px;bottom:843px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#th_3884{left:69px;bottom:819px;letter-spacing:-0.13px;word-spacing:-0.47px;}
#ti_3884{left:69px;bottom:802px;letter-spacing:-0.16px;word-spacing:-0.46px;}
#tj_3884{left:69px;bottom:785px;letter-spacing:-0.14px;word-spacing:-1.28px;}
#tk_3884{left:69px;bottom:768px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tl_3884{left:69px;bottom:752px;letter-spacing:-0.14px;word-spacing:-1.03px;}
#tm_3884{left:69px;bottom:735px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#tn_3884{left:69px;bottom:718px;letter-spacing:-0.15px;word-spacing:-1.21px;}
#to_3884{left:69px;bottom:701px;letter-spacing:-0.14px;word-spacing:-1.24px;}
#tp_3884{left:69px;bottom:684px;letter-spacing:-0.15px;word-spacing:-1.16px;}
#tq_3884{left:69px;bottom:668px;letter-spacing:-0.16px;word-spacing:-0.77px;}
#tr_3884{left:69px;bottom:651px;letter-spacing:-0.13px;word-spacing:-1.26px;}
#ts_3884{left:69px;bottom:634px;letter-spacing:-0.14px;word-spacing:-1.26px;}
#tt_3884{left:69px;bottom:617px;letter-spacing:-0.14px;word-spacing:-0.9px;}
#tu_3884{left:69px;bottom:600px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tv_3884{left:69px;bottom:576px;letter-spacing:-0.13px;word-spacing:-1.23px;}
#tw_3884{left:69px;bottom:559px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tx_3884{left:69px;bottom:535px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#ty_3884{left:69px;bottom:518px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tz_3884{left:69px;bottom:501px;letter-spacing:-0.17px;word-spacing:-0.42px;}
#t10_3884{left:69px;bottom:477px;letter-spacing:-0.13px;word-spacing:-0.85px;}
#t11_3884{left:69px;bottom:460px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t12_3884{left:69px;bottom:443px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#t13_3884{left:69px;bottom:426px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#t14_3884{left:69px;bottom:402px;letter-spacing:-0.23px;word-spacing:-0.39px;}
#t15_3884{left:69px;bottom:385px;letter-spacing:-0.13px;word-spacing:-0.48px;}
#t16_3884{left:69px;bottom:360px;letter-spacing:-0.13px;word-spacing:-0.51px;}
#t17_3884{left:69px;bottom:344px;letter-spacing:-0.14px;word-spacing:-1.15px;}
#t18_3884{left:69px;bottom:327px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t19_3884{left:69px;bottom:310px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t1a_3884{left:69px;bottom:293px;letter-spacing:-0.13px;word-spacing:-0.65px;}
#t1b_3884{left:69px;bottom:276px;letter-spacing:-0.17px;word-spacing:-0.87px;}
#t1c_3884{left:69px;bottom:260px;letter-spacing:-0.14px;word-spacing:-0.47px;}

.s1_3884{font-size:12px;font-family:NeoSansIntel_6wv3;color:#000;}
.s2_3884{font-size:14px;font-family:NeoSansIntel_6wv3;color:#0860A8;}
.s3_3884{font-size:14px;font-family:Verdana_b5t;color:#000;}
.s4_3884{font-size:21px;font-family:NeoSansIntelMedium_6wv2;color:#0860A8;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts3884" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_6wv2;
	src: url("fonts/NeoSansIntelMedium_6wv2.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_6wv3;
	src: url("fonts/NeoSansIntel_6wv3.woff") format("woff");
}

@font-face {
	font-family: Verdana_b5t;
	src: url("fonts/Verdana_b5t.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg3884Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg3884" style="-webkit-user-select: none;"><object width="935" height="1210" data="3884/3884.svg" type="image/svg+xml" id="pdf3884" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_3884" class="t s1_3884">21-20 </span><span id="t2_3884" class="t s1_3884">Vol. 3B </span>
<span id="t3_3884" class="t s2_3884">8086 EMULATION </span>
<span id="t4_3884" class="t s3_3884">Method 6 differs from method 5 in that with the IOPL value set to less than 3, the VIF and VIP flags in the EFLAGS </span>
<span id="t5_3884" class="t s3_3884">register are enabled, providing virtual interrupt support for handling class 2 maskable hardware interrupts (see </span>
<span id="t6_3884" class="t s3_3884">Section 21.3.2, “Class 2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the Virtual Interrupt </span>
<span id="t7_3884" class="t s3_3884">Mechanism”). These flags provide the virtual-8086 monitor with an efficient means of handling maskable hardware </span>
<span id="t8_3884" class="t s3_3884">interrupts that occur during a virtual-8086 mode task. Also, because the IOPL value is less than 3 and the VIF flag </span>
<span id="t9_3884" class="t s3_3884">is enabled, the information pushed on the stack by the processor when invoking the interrupt handler is slightly </span>
<span id="ta_3884" class="t s3_3884">different between methods 5 and 6 (see Table 21-2). </span>
<span id="tb_3884" class="t s4_3884">21.4 </span><span id="tc_3884" class="t s4_3884">PROTECTED-MODE VIRTUAL INTERRUPTS </span>
<span id="td_3884" class="t s3_3884">The IA-32 processors (beginning with the Pentium processor) also support the VIF and VIP flags in the EFLAGS </span>
<span id="te_3884" class="t s3_3884">register in protected mode by setting the PVI (protected-mode virtual interrupt) flag in the CR4 register. Setting the </span>
<span id="tf_3884" class="t s3_3884">PVI flag allows applications running at privilege level 3 to execute the CLI and STI instructions without causing a </span>
<span id="tg_3884" class="t s3_3884">general-protection exception (#GP) or affecting hardware interrupts. </span>
<span id="th_3884" class="t s3_3884">When the PVI flag is set to 1, the CPL is 3, and the IOPL is less than 3, the STI and CLI instructions set and clear </span>
<span id="ti_3884" class="t s3_3884">the VIF flag in the EFLAGS register, leaving IF unaffected. In this mode of operation, an application running in </span>
<span id="tj_3884" class="t s3_3884">protected mode and at a CPL of 3 can inhibit interrupts in the same manner as is described in Section 21.3.2, “Class </span>
<span id="tk_3884" class="t s3_3884">2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the Virtual Interrupt Mechanism,” for a </span>
<span id="tl_3884" class="t s3_3884">virtual-8086 mode task. When the application executes the CLI instruction, the processor clears the VIF flag. If the </span>
<span id="tm_3884" class="t s3_3884">processor receives a maskable hardware interrupt, the processor invokes the protected-mode interrupt handler. </span>
<span id="tn_3884" class="t s3_3884">This handler checks the state of the VIF flag in the EFLAGS register. If the VIF flag is clear (indicating that the active </span>
<span id="to_3884" class="t s3_3884">task does not want to have interrupts handled now), the handler sets the VIP flag in the EFLAGS image on the stack </span>
<span id="tp_3884" class="t s3_3884">and returns to the privilege-level 3 application, which continues program execution. When the application executes </span>
<span id="tq_3884" class="t s3_3884">a STI instruction to set the VIF flag, the processor automatically invokes the general-protection exception handler, </span>
<span id="tr_3884" class="t s3_3884">which can then handle the pending interrupt. After handing the pending interrupt, the handler typically sets the VIF </span>
<span id="ts_3884" class="t s3_3884">flag and clears the VIP flag in the EFLAGS image on the stack and executes a return to the application program. The </span>
<span id="tt_3884" class="t s3_3884">next time the processor receives a maskable hardware interrupt, the processor will handle it in the normal manner </span>
<span id="tu_3884" class="t s3_3884">for interrupts received while the processor is operating at a CPL of 3. </span>
<span id="tv_3884" class="t s3_3884">If the protected-mode virtual interrupt extension is enabled, CPL = 3, and the processor finds that both the VIF and </span>
<span id="tw_3884" class="t s3_3884">VIP flags are set at the beginning of an instruction, a general-protection exception is generated. </span>
<span id="tx_3884" class="t s3_3884">Because the protected-mode virtual interrupt extension changes only the treatment of EFLAGS.IF (by having CLI </span>
<span id="ty_3884" class="t s3_3884">and STI update EFLAGS.VIF instead), it affects only the masking of maskable hardware interrupts (interrupt </span>
<span id="tz_3884" class="t s3_3884">vectors 32 through 255). NMI interrupts and exceptions are handled in the normal manner. </span>
<span id="t10_3884" class="t s3_3884">(When protected-mode virtual interrupts are disabled (that is, when the PVI flag in control register CR4 is set to 0, </span>
<span id="t11_3884" class="t s3_3884">the CPL is less than 3, or the IOPL value is 3), then the CLI and STI instructions execute in a manner compatible </span>
<span id="t12_3884" class="t s3_3884">with the Intel486 processor. That is, if the CPL is greater (less privileged) than the I/O privilege level (IOPL), a </span>
<span id="t13_3884" class="t s3_3884">general-protection exception occurs. If the IOPL value is 3, CLI and STI clear or set the IF flag, respectively.) </span>
<span id="t14_3884" class="t s3_3884">PUSHF, POPF, IRET, and INT are executed like in the Intel486 processor, regardless of whether protected-mode </span>
<span id="t15_3884" class="t s3_3884">virtual interrupts are enabled. </span>
<span id="t16_3884" class="t s3_3884">It is only possible to enter virtual-8086 mode through a task switch or the execution of an IRET instruction, and it </span>
<span id="t17_3884" class="t s3_3884">is only possible to leave virtual-8086 mode by faulting to a protected-mode interrupt handler (typically the general- </span>
<span id="t18_3884" class="t s3_3884">protection exception handler, which in turn calls the virtual 8086-mode monitor). In both cases, the EFLAGS </span>
<span id="t19_3884" class="t s3_3884">register is saved and restored. This is not true, however, in protected mode when the PVI flag is set and the </span>
<span id="t1a_3884" class="t s3_3884">processor is not in virtual-8086 mode. Here, it is possible to call a procedure at a different privilege level, in which </span>
<span id="t1b_3884" class="t s3_3884">case the EFLAGS register is not saved or modified. However, the states of VIF and VIP flags are never examined by </span>
<span id="t1c_3884" class="t s3_3884">the processor when the CPL is not 3. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
