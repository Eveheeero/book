<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p66" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_66{left:110px;bottom:1129px;letter-spacing:-0.17px;}
#t2_66{left:475px;bottom:1129px;letter-spacing:-0.21px;word-spacing:1.47px;}
#t3_66{left:110px;bottom:1082px;letter-spacing:-0.42px;}
#t4_66{left:162px;bottom:1082px;letter-spacing:-0.14px;word-spacing:0.23px;}
#t5_66{left:110px;bottom:1062px;letter-spacing:-0.13px;word-spacing:2.8px;}
#t6_66{left:513px;bottom:1062px;letter-spacing:-0.16px;}
#t7_66{left:535px;bottom:1062px;letter-spacing:-0.18px;}
#t8_66{left:569px;bottom:1062px;letter-spacing:-0.11px;}
#t9_66{left:587px;bottom:1062px;letter-spacing:-0.15px;word-spacing:2.43px;}
#ta_66{left:110px;bottom:1041px;letter-spacing:-0.09px;word-spacing:1.88px;}
#tb_66{left:203px;bottom:1041px;letter-spacing:-0.18px;word-spacing:2.43px;}
#tc_66{left:371px;bottom:1041px;letter-spacing:-0.14px;word-spacing:1.96px;}
#td_66{left:110px;bottom:1020px;letter-spacing:-0.14px;word-spacing:0.85px;}
#te_66{left:110px;bottom:999px;letter-spacing:-0.17px;}
#tf_66{left:110px;bottom:929px;letter-spacing:-0.04px;}
#tg_66{left:166px;bottom:929px;letter-spacing:-0.06px;word-spacing:2.77px;}
#th_66{left:134px;bottom:882px;letter-spacing:0.09px;}
#ti_66{left:214px;bottom:882px;letter-spacing:0.09px;}
#tj_66{left:241px;bottom:882px;letter-spacing:0.09px;}
#tk_66{left:280px;bottom:882px;letter-spacing:0.09px;}
#tl_66{left:312px;bottom:882px;letter-spacing:0.09px;}
#tm_66{left:393px;bottom:882px;letter-spacing:0.09px;word-spacing:2.51px;}
#tn_66{left:492px;bottom:882px;letter-spacing:0.09px;word-spacing:2.51px;}
#to_66{left:551px;bottom:882px;letter-spacing:0.09px;}
#tp_66{left:575px;bottom:882px;letter-spacing:0.09px;}
#tq_66{left:662px;bottom:882px;letter-spacing:5.7px;}
#tr_66{left:800px;bottom:882px;}
#ts_66{left:150px;bottom:858px;letter-spacing:-0.15px;}
#tt_66{left:238px;bottom:858px;letter-spacing:-0.17px;}
#tu_66{left:281px;bottom:858px;letter-spacing:-0.11px;}
#tv_66{left:345px;bottom:858px;letter-spacing:-0.14px;}
#tw_66{left:444px;bottom:858px;letter-spacing:-0.14px;}
#tx_66{left:514px;bottom:858px;letter-spacing:-0.15px;}
#ty_66{left:610px;bottom:858px;letter-spacing:-0.16px;}
#tz_66{left:716px;bottom:858px;letter-spacing:0.02px;}
#t10_66{left:174px;bottom:837px;}
#t11_66{left:243px;bottom:837px;}
#t12_66{left:282px;bottom:837px;}
#t13_66{left:352px;bottom:837px;}
#t14_66{left:451px;bottom:837px;}
#t15_66{left:530px;bottom:837px;}
#t16_66{left:614px;bottom:837px;}
#t17_66{left:733px;bottom:837px;}
#t18_66{left:145px;bottom:816px;letter-spacing:-0.22px;}
#t19_66{left:237px;bottom:816px;letter-spacing:-0.15px;}
#t1a_66{left:352px;bottom:816px;}
#t1b_66{left:438px;bottom:816px;letter-spacing:-0.17px;}
#t1c_66{left:513px;bottom:816px;letter-spacing:-0.17px;}
#t1d_66{left:604px;bottom:816px;letter-spacing:-0.14px;}
#t1e_66{left:717px;bottom:816px;letter-spacing:-0.27px;}
#t1f_66{left:146px;bottom:796px;letter-spacing:-0.21px;}
#t1g_66{left:237px;bottom:796px;letter-spacing:-0.15px;}
#t1h_66{left:346px;bottom:796px;letter-spacing:-0.14px;}
#t1i_66{left:438px;bottom:796px;letter-spacing:-0.17px;}
#t1j_66{left:513px;bottom:796px;letter-spacing:-0.17px;}
#t1k_66{left:604px;bottom:796px;letter-spacing:-0.15px;}
#t1l_66{left:717px;bottom:796px;letter-spacing:-0.27px;}
#t1m_66{left:110px;bottom:743px;letter-spacing:-0.15px;word-spacing:-0.23px;}
#t1n_66{left:110px;bottom:722px;letter-spacing:-0.17px;word-spacing:2.08px;}
#t1o_66{left:110px;bottom:702px;letter-spacing:-0.14px;}
#t1p_66{left:131px;bottom:702px;letter-spacing:-0.15px;}
#t1q_66{left:153px;bottom:702px;letter-spacing:-0.19px;word-spacing:3.03px;}
#t1r_66{left:418px;bottom:702px;letter-spacing:-1px;}
#t1s_66{left:433px;bottom:702px;letter-spacing:-0.14px;word-spacing:3.01px;}
#t1t_66{left:562px;bottom:702px;letter-spacing:-0.21px;word-spacing:3.31px;}
#t1u_66{left:669px;bottom:702px;letter-spacing:-0.2px;word-spacing:2.96px;}
#t1v_66{left:110px;bottom:681px;letter-spacing:-0.18px;word-spacing:1.19px;}
#t1w_66{left:695px;bottom:681px;letter-spacing:-0.15px;}
#t1x_66{left:723px;bottom:681px;letter-spacing:-0.15px;word-spacing:0.96px;}
#t1y_66{left:110px;bottom:660px;letter-spacing:-0.14px;}
#t1z_66{left:130px;bottom:660px;letter-spacing:-0.15px;}
#t20_66{left:152px;bottom:660px;letter-spacing:-0.19px;word-spacing:1.69px;}
#t21_66{left:110px;bottom:639px;letter-spacing:-0.16px;word-spacing:1.67px;}
#t22_66{left:682px;bottom:639px;letter-spacing:-0.15px;}
#t23_66{left:710px;bottom:639px;letter-spacing:-0.32px;word-spacing:1.81px;}
#t24_66{left:110px;bottom:619px;letter-spacing:-0.14px;word-spacing:2.12px;}
#t25_66{left:234px;bottom:619px;letter-spacing:-1px;}
#t26_66{left:249px;bottom:619px;letter-spacing:-0.17px;word-spacing:2.41px;}
#t27_66{left:110px;bottom:598px;letter-spacing:-0.24px;word-spacing:2.88px;}
#t28_66{left:239px;bottom:598px;letter-spacing:-1px;}
#t29_66{left:254px;bottom:598px;}
#t2a_66{left:270px;bottom:598px;letter-spacing:-0.17px;word-spacing:2.79px;}
#t2b_66{left:110px;bottom:577px;letter-spacing:-0.19px;word-spacing:2.48px;}
#t2c_66{left:110px;bottom:557px;letter-spacing:-0.31px;word-spacing:1.84px;}
#t2d_66{left:696px;bottom:557px;letter-spacing:-1px;}
#t2e_66{left:710px;bottom:557px;}
#t2f_66{left:152px;bottom:512px;letter-spacing:-0.02px;word-spacing:1.78px;}
#t2g_66{left:152px;bottom:494px;letter-spacing:0.04px;word-spacing:2.99px;}
#t2h_66{left:152px;bottom:476px;letter-spacing:0.01px;word-spacing:2.49px;}
#t2i_66{left:152px;bottom:457px;letter-spacing:0.03px;word-spacing:1.25px;}
#t2j_66{left:152px;bottom:439px;letter-spacing:-0.04px;word-spacing:1.43px;}
#t2k_66{left:152px;bottom:421px;word-spacing:3.26px;}
#t2l_66{left:152px;bottom:402px;letter-spacing:0.09px;word-spacing:3.18px;}
#t2m_66{left:152px;bottom:384px;letter-spacing:-0.06px;word-spacing:2.83px;}
#t2n_66{left:152px;bottom:366px;letter-spacing:0.08px;word-spacing:2.68px;}
#t2o_66{left:152px;bottom:348px;letter-spacing:0.06px;word-spacing:2.92px;}
#t2p_66{left:152px;bottom:329px;letter-spacing:-0.02px;word-spacing:2.62px;}
#t2q_66{left:152px;bottom:311px;letter-spacing:0.01px;word-spacing:1.41px;}
#t2r_66{left:152px;bottom:293px;letter-spacing:0.01px;word-spacing:1.81px;}
#t2s_66{left:177px;bottom:275px;letter-spacing:0.07px;word-spacing:1.93px;}
#t2t_66{left:152px;bottom:256px;letter-spacing:-0.05px;word-spacing:2.11px;}
#t2u_66{left:152px;bottom:238px;letter-spacing:0.02px;word-spacing:2.59px;}
#t2v_66{left:152px;bottom:220px;letter-spacing:0.02px;word-spacing:1.47px;}
#t2w_66{left:152px;bottom:202px;letter-spacing:0.06px;word-spacing:3.5px;}
#t2x_66{left:330px;bottom:202px;letter-spacing:0.02px;word-spacing:3.57px;}
#t2y_66{left:152px;bottom:183px;letter-spacing:0.07px;word-spacing:1.72px;}
#t2z_66{left:177px;bottom:165px;letter-spacing:0.04px;word-spacing:3.45px;}
#t30_66{left:152px;bottom:147px;letter-spacing:-0.01px;word-spacing:2.18px;}
#t31_66{left:152px;bottom:129px;letter-spacing:0.1px;word-spacing:2.62px;}
#t32_66{left:225px;bottom:129px;letter-spacing:0.04px;word-spacing:2.74px;}

.s1_66{font-size:17px;font-family:CMR10_270;color:#000;}
.s2_66{font-size:17px;font-family:CMSL10_27d;color:#000;}
.s3_66{font-size:17px;font-family:CMTI10_27t;color:#000;}
.s4_66{font-size:22px;font-family:CMBX12_26j;color:#000;}
.s5_66{font-size:12px;font-family:CMR8_278;color:#000;}
.s6_66{font-size:15px;font-family:CMTI10_27t;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts66" type="text/css" >

@font-face {
	font-family: CMBX12_26j;
	src: url("fonts/CMBX12_26j.woff") format("woff");
}

@font-face {
	font-family: CMR10_270;
	src: url("fonts/CMR10_270.woff") format("woff");
}

@font-face {
	font-family: CMR8_278;
	src: url("fonts/CMR8_278.woff") format("woff");
}

@font-face {
	font-family: CMSL10_27d;
	src: url("fonts/CMSL10_27d.woff") format("woff");
}

@font-face {
	font-family: CMTI10_27t;
	src: url("fonts/CMTI10_27t.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg66Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg66" style="-webkit-user-select: none;"><object width="935" height="1210" data="66/66.svg" type="image/svg+xml" id="pdf66" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_66" class="t s1_66">48 </span><span id="t2_66" class="t s2_66">Volume I: RISC-V Unprivileged ISA V20191213 </span>
<span id="t3_66" class="t s3_66">release </span><span id="t4_66" class="t s1_66">access, i.e., the release memory operation cannot be observed to take place before any earlier </span>
<span id="t5_66" class="t s1_66">memory operations on this RISC-V hart. If both the </span><span id="t6_66" class="t s3_66">aq </span><span id="t7_66" class="t s1_66">and </span><span id="t8_66" class="t s3_66">rl </span><span id="t9_66" class="t s1_66">bits are set, the atomic memory </span>
<span id="ta_66" class="t s1_66">operation is </span><span id="tb_66" class="t s3_66">sequentially consistent </span><span id="tc_66" class="t s1_66">and cannot be observed to happen before any earlier memory </span>
<span id="td_66" class="t s1_66">operations or after any later memory operations in the same RISC-V hart and to the same address </span>
<span id="te_66" class="t s1_66">domain. </span>
<span id="tf_66" class="t s4_66">8.2 </span><span id="tg_66" class="t s4_66">Load-Reserved/Store-Conditional Instructions </span>
<span id="th_66" class="t s5_66">31 </span><span id="ti_66" class="t s5_66">27 </span><span id="tj_66" class="t s5_66">26 </span><span id="tk_66" class="t s5_66">25 </span><span id="tl_66" class="t s5_66">24 </span><span id="tm_66" class="t s5_66">20 19 </span><span id="tn_66" class="t s5_66">15 14 </span><span id="to_66" class="t s5_66">12 </span><span id="tp_66" class="t s5_66">11 </span><span id="tq_66" class="t s5_66">76 </span><span id="tr_66" class="t s5_66">0 </span>
<span id="ts_66" class="t s1_66">funct5 </span><span id="tt_66" class="t s1_66">aq </span><span id="tu_66" class="t s1_66">rl </span><span id="tv_66" class="t s1_66">rs2 </span><span id="tw_66" class="t s1_66">rs1 </span><span id="tx_66" class="t s1_66">funct3 </span><span id="ty_66" class="t s1_66">rd </span><span id="tz_66" class="t s1_66">opcode </span>
<span id="t10_66" class="t s1_66">5 </span><span id="t11_66" class="t s1_66">1 </span><span id="t12_66" class="t s1_66">1 </span><span id="t13_66" class="t s1_66">5 </span><span id="t14_66" class="t s1_66">5 </span><span id="t15_66" class="t s1_66">3 </span><span id="t16_66" class="t s1_66">5 </span><span id="t17_66" class="t s1_66">7 </span>
<span id="t18_66" class="t s1_66">LR.W/D </span><span id="t19_66" class="t s1_66">ordering </span><span id="t1a_66" class="t s1_66">0 </span><span id="t1b_66" class="t s1_66">addr </span><span id="t1c_66" class="t s1_66">width </span><span id="t1d_66" class="t s1_66">dest </span><span id="t1e_66" class="t s1_66">AMO </span>
<span id="t1f_66" class="t s1_66">SC.W/D </span><span id="t1g_66" class="t s1_66">ordering </span><span id="t1h_66" class="t s1_66">src </span><span id="t1i_66" class="t s1_66">addr </span><span id="t1j_66" class="t s1_66">width </span><span id="t1k_66" class="t s1_66">dest </span><span id="t1l_66" class="t s1_66">AMO </span>
<span id="t1m_66" class="t s1_66">Complex atomic memory operations on a single memory word or doubleword are performed with the </span>
<span id="t1n_66" class="t s1_66">load-reserved (LR) and store-conditional (SC) instructions. LR.W loads a word from the address </span>
<span id="t1o_66" class="t s1_66">in </span><span id="t1p_66" class="t s3_66">rs1</span><span id="t1q_66" class="t s1_66">, places the sign-extended value in </span><span id="t1r_66" class="t s3_66">rd</span><span id="t1s_66" class="t s1_66">, and registers a </span><span id="t1t_66" class="t s3_66">reservation set</span><span id="t1u_66" class="t s1_66">—a set of bytes that </span>
<span id="t1v_66" class="t s1_66">subsumes the bytes in the addressed word. SC.W conditionally writes a word in </span><span id="t1w_66" class="t s3_66">rs2 </span><span id="t1x_66" class="t s1_66">to the address </span>
<span id="t1y_66" class="t s1_66">in </span><span id="t1z_66" class="t s3_66">rs1</span><span id="t20_66" class="t s1_66">: the SC.W succeeds only if the reservation is still valid and the reservation set contains the </span>
<span id="t21_66" class="t s1_66">bytes being written. If the SC.W succeeds, the instruction writes the word in </span><span id="t22_66" class="t s3_66">rs2 </span><span id="t23_66" class="t s1_66">to memory, and </span>
<span id="t24_66" class="t s1_66">it writes zero to </span><span id="t25_66" class="t s3_66">rd</span><span id="t26_66" class="t s1_66">. If the SC.W fails, the instruction does not write to memory, and it writes a </span>
<span id="t27_66" class="t s1_66">nonzero value to </span><span id="t28_66" class="t s3_66">rd</span><span id="t29_66" class="t s1_66">. </span><span id="t2a_66" class="t s1_66">Regardless of success or failure, executing an SC.W instruction invalidates </span>
<span id="t2b_66" class="t s1_66">any reservation held by this hart. LR.D and SC.D act analogously on doublewords and are only </span>
<span id="t2c_66" class="t s1_66">available on RV64. For RV64, LR.W and SC.W sign-extend the value placed in </span><span id="t2d_66" class="t s3_66">rd</span><span id="t2e_66" class="t s1_66">. </span>
<span id="t2f_66" class="t s6_66">Both compare-and-swap (CAS) and LR/SC can be used to build lock-free data structures. After </span>
<span id="t2g_66" class="t s6_66" data-mappings='[[71,"ff"]]'>extensive discussion, we opted for LR/SC for several reasons: 1) CAS suﬀers from the ABA </span>
<span id="t2h_66" class="t s6_66">problem, which LR/SC avoids because it monitors all accesses to the address rather than only </span>
<span id="t2i_66" class="t s6_66">checking for changes in the data value; 2) CAS would also require a new integer instruction for- </span>
<span id="t2j_66" class="t s6_66" data-mappings='[[89,"ff"]]'>mat to support three source operands (address, compare value, swap value) as well as a diﬀerent </span>
<span id="t2k_66" class="t s6_66">memory system message format, which would complicate microarchitectures; 3) Furthermore, </span>
<span id="t2l_66" class="t s6_66">to avoid the ABA problem, other systems provide a double-wide CAS (DW-CAS) to allow a </span>
<span id="t2m_66" class="t s6_66" data-mappings='[[83,"fi"]]'>counter to be tested and incremented along with a data word. This requires reading ﬁve regis- </span>
<span id="t2n_66" class="t s6_66">ters and writing two in one instruction, and also a new larger memory system message type, </span>
<span id="t2o_66" class="t s6_66" data-mappings='[[64,"ffi"]]'>further complicating implementations; 4) LR/SC provides a more eﬃcient implementation of </span>
<span id="t2p_66" class="t s6_66">many primitives as it only requires one load as opposed to two with CAS (one load before the </span>
<span id="t2q_66" class="t s6_66">CAS instruction to obtain a value for speculative computation, then a second load as part of the </span>
<span id="t2r_66" class="t s6_66">CAS instruction to check if value is unchanged before updating). </span>
<span id="t2s_66" class="t s6_66">The main disadvantage of LR/SC over CAS is livelock, which we avoid, under certain cir- </span>
<span id="t2t_66" class="t s6_66">cumstances, with an architected guarantee of eventual forward progress as described below. An- </span>
<span id="t2u_66" class="t s6_66" data-mappings='[[31,"fl"]]'>other concern is whether the inﬂuence of the current x86 architecture, with its DW-CAS, will </span>
<span id="t2v_66" class="t s6_66">complicate porting of synchronization libraries and other software that assumes DW-CAS is the </span>
<span id="t2w_66" class="t s6_66">basic machine primitive. </span><span id="t2x_66" class="t s6_66">A possible mitigating factor is the recent addition of transactional </span>
<span id="t2y_66" class="t s6_66">memory instructions to x86, which might cause a move away from DW-CAS. </span>
<span id="t2z_66" class="t s6_66">More generally, a multi-word atomic primitive is desirable, but there is still considerable </span>
<span id="t30_66" class="t s6_66">debate about what form this should take, and guaranteeing forward progress adds complexity to </span>
<span id="t31_66" class="t s6_66">a system. </span><span id="t32_66" class="t s6_66">Our current thoughts are to include a small limited-capacity transactional memory </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
