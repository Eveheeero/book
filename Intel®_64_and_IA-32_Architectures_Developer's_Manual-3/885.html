<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p885" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_885{left:775px;bottom:68px;letter-spacing:0.1px;}
#t2_885{left:820px;bottom:68px;letter-spacing:0.12px;}
#t3_885{left:747px;bottom:1141px;letter-spacing:-0.14px;}
#t4_885{left:70px;bottom:1083px;letter-spacing:0.13px;}
#t5_885{left:152px;bottom:1083px;letter-spacing:0.15px;word-spacing:0.01px;}
#t6_885{left:152px;bottom:1061px;letter-spacing:0.15px;word-spacing:0.01px;}
#t7_885{left:70px;bottom:1037px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#t8_885{left:70px;bottom:1020px;letter-spacing:-0.14px;word-spacing:-0.63px;}
#t9_885{left:70px;bottom:1004px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#ta_885{left:70px;bottom:979px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tb_885{left:70px;bottom:962px;letter-spacing:-0.14px;word-spacing:-0.44px;}
#tc_885{left:70px;bottom:936px;}
#td_885{left:96px;bottom:940px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#te_885{left:70px;bottom:913px;}
#tf_885{left:96px;bottom:917px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#tg_885{left:70px;bottom:892px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#th_885{left:70px;bottom:875px;letter-spacing:-0.15px;word-spacing:-1.07px;}
#ti_885{left:70px;bottom:859px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#tj_885{left:70px;bottom:842px;letter-spacing:-0.18px;word-spacing:-0.41px;}
#tk_885{left:441px;bottom:802px;letter-spacing:-0.13px;}
#tl_885{left:124px;bottom:781px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tm_885{left:124px;bottom:764px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tn_885{left:124px;bottom:747px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#to_885{left:124px;bottom:730px;letter-spacing:-0.13px;word-spacing:-1px;}
#tp_885{left:124px;bottom:713px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tq_885{left:70px;bottom:668px;letter-spacing:-0.14px;word-spacing:-0.85px;}
#tr_885{left:70px;bottom:651px;letter-spacing:-0.14px;word-spacing:-0.61px;}
#ts_885{left:70px;bottom:634px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tt_885{left:70px;bottom:617px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#tu_885{left:70px;bottom:600px;letter-spacing:-0.15px;word-spacing:-0.47px;}
#tv_885{left:70px;bottom:584px;letter-spacing:-0.15px;word-spacing:-0.48px;}
#tw_885{left:70px;bottom:567px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tx_885{left:70px;bottom:542px;letter-spacing:-0.14px;word-spacing:-0.87px;}
#ty_885{left:70px;bottom:525px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tz_885{left:70px;bottom:509px;letter-spacing:-0.14px;word-spacing:-1.07px;}
#t10_885{left:70px;bottom:492px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t11_885{left:70px;bottom:475px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t12_885{left:70px;bottom:458px;letter-spacing:-0.14px;word-spacing:-0.82px;}
#t13_885{left:70px;bottom:441px;letter-spacing:-0.15px;word-spacing:-1.28px;}
#t14_885{left:70px;bottom:425px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t15_885{left:70px;bottom:408px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t16_885{left:70px;bottom:383px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t17_885{left:70px;bottom:367px;letter-spacing:-0.13px;word-spacing:-0.55px;}
#t18_885{left:70px;bottom:350px;letter-spacing:-0.15px;}
#t19_885{left:70px;bottom:325px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#t1a_885{left:70px;bottom:309px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t1b_885{left:70px;bottom:292px;letter-spacing:-0.15px;word-spacing:-0.5px;}
#t1c_885{left:70px;bottom:267px;letter-spacing:-0.14px;}
#t1d_885{left:96px;bottom:267px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t1e_885{left:96px;bottom:250px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#t1f_885{left:96px;bottom:234px;letter-spacing:-0.15px;word-spacing:-0.6px;}
#t1g_885{left:96px;bottom:217px;letter-spacing:-0.15px;}
#t1h_885{left:96px;bottom:192px;letter-spacing:-0.14px;}
#t1i_885{left:122px;bottom:192px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t1j_885{left:96px;bottom:168px;letter-spacing:-0.26px;}
#t1k_885{left:122px;bottom:168px;letter-spacing:-0.19px;word-spacing:-0.69px;}
#t1l_885{left:122px;bottom:151px;letter-spacing:-0.15px;word-spacing:-0.44px;}
#t1m_885{left:96px;bottom:127px;letter-spacing:-0.11px;}
#t1n_885{left:122px;bottom:127px;letter-spacing:-0.13px;word-spacing:-0.49px;}

.s1_885{font-size:12px;font-family:NeoSansIntel_1uk1;color:#000;}
.s2_885{font-size:14px;font-family:NeoSansIntel_1uk1;color:#0860A8;}
.s3_885{font-size:18px;font-family:NeoSansIntelMedium_1uk0;color:#0860A8;}
.s4_885{font-size:14px;font-family:Verdana_3e8;color:#000;}
.s5_885{font-size:21px;font-family:TimesNewRoman_3ec;color:#000;}
.s6_885{font-size:17px;font-family:NeoSansIntelMedium_1uk0;color:#0860A8;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts885" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_1uk0;
	src: url("fonts/NeoSansIntelMedium_1uk0.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_1uk1;
	src: url("fonts/NeoSansIntel_1uk1.woff") format("woff");
}

@font-face {
	font-family: TimesNewRoman_3ec;
	src: url("fonts/TimesNewRoman_3ec.woff") format("woff");
}

@font-face {
	font-family: Verdana_3e8;
	src: url("fonts/Verdana_3e8.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg885Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg885" style="-webkit-user-select: none;"><object width="935" height="1210" data="885/885.svg" type="image/svg+xml" id="pdf885" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_885" class="t s1_885">Vol. 3B </span><span id="t2_885" class="t s1_885">21-15 </span>
<span id="t3_885" class="t s2_885">8086 EMULATION </span>
<span id="t4_885" class="t s3_885">21.3.2 </span><span id="t5_885" class="t s3_885">Class 2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the </span>
<span id="t6_885" class="t s3_885">Virtual Interrupt Mechanism </span>
<span id="t7_885" class="t s4_885">Maskable hardware interrupts are those interrupts that are delivered through the INTR# pin or through an inter- </span>
<span id="t8_885" class="t s4_885">rupt request to the local APIC (see Section 6.3.2, “Maskable Hardware Interrupts”). These interrupts can be inhib- </span>
<span id="t9_885" class="t s4_885">ited (masked) from interrupting an executing program or task by clearing the IF flag in the EFLAGS register. </span>
<span id="ta_885" class="t s4_885">When the VME flag in control register CR4 is set and the IOPL field in the EFLAGS register is less than 3, two addi- </span>
<span id="tb_885" class="t s4_885">tional flags are activated in the EFLAGS register: </span>
<span id="tc_885" class="t s5_885">• </span><span id="td_885" class="t s4_885">VIF (virtual interrupt) flag, bit 19 of the EFLAGS register. </span>
<span id="te_885" class="t s5_885">• </span><span id="tf_885" class="t s4_885">VIP (virtual interrupt pending) flag, bit 20 of the EFLAGS register. </span>
<span id="tg_885" class="t s4_885">These flags provide the virtual-8086 monitor with more efficient control over handling maskable hardware inter- </span>
<span id="th_885" class="t s4_885">rupts that occur during virtual-8086 mode tasks. They also reduce interrupt-handling overhead, by eliminating the </span>
<span id="ti_885" class="t s4_885">need for all IF related operations (such as PUSHF, POPF, CLI, and STI instructions) to trap to the virtual-8086 </span>
<span id="tj_885" class="t s4_885">monitor. The purpose and use of these flags are as follows. </span>
<span id="tk_885" class="t s6_885">NOTE </span>
<span id="tl_885" class="t s4_885">The VIF and VIP flags are only available in IA-32 processors that support the virtual mode </span>
<span id="tm_885" class="t s4_885">extensions. These extensions were introduced in the IA-32 architecture with the Pentium </span>
<span id="tn_885" class="t s4_885">processor. When this mechanism is either not available or not enabled, maskable hardware </span>
<span id="to_885" class="t s4_885">interrupts are handled as class 1 interrupts. Here, if VIF and VIP flags are needed, the virtual-8086 </span>
<span id="tp_885" class="t s4_885">monitor can implement them in software. </span>
<span id="tq_885" class="t s4_885">Existing 8086 programs commonly set and clear the IF flag in the EFLAGS register to enable and disable maskable </span>
<span id="tr_885" class="t s4_885">hardware interrupts, respectively; for example, to disable interrupts while handling another interrupt or an excep- </span>
<span id="ts_885" class="t s4_885">tion. This practice works well in single task environments, but can cause problems in multitasking and multiple- </span>
<span id="tt_885" class="t s4_885">processor environments, where it is often desirable to prevent an application program from having direct control </span>
<span id="tu_885" class="t s4_885">over the handling of hardware interrupts. When using earlier IA-32 processors, this problem was often solved by </span>
<span id="tv_885" class="t s4_885">creating a virtual IF flag in software. The IA-32 processors (beginning with the Pentium processor) provide hard- </span>
<span id="tw_885" class="t s4_885">ware support for this virtual IF flag through the VIF and VIP flags. </span>
<span id="tx_885" class="t s4_885">The VIF flag is a virtualized version of the IF flag, which an application program running from within a virtual-8086 </span>
<span id="ty_885" class="t s4_885">task can used to control the handling of maskable hardware interrupts. When the VIF flag is enabled, the CLI and </span>
<span id="tz_885" class="t s4_885">STI instructions operate on the VIF flag instead of the IF flag. When an 8086 program executes the CLI instruction, </span>
<span id="t10_885" class="t s4_885">the processor clears the VIF flag to request that the virtual-8086 monitor inhibit maskable hardware interrupts </span>
<span id="t11_885" class="t s4_885">from interrupting program execution; when it executes the STI instruction, the processor sets the VIF flag </span>
<span id="t12_885" class="t s4_885">requesting that the virtual-8086 monitor enable maskable hardware interrupts for the 8086 program. But actually </span>
<span id="t13_885" class="t s4_885">the IF flag, managed by the operating system, always controls whether maskable hardware interrupts are enabled. </span>
<span id="t14_885" class="t s4_885">Also, if under these circumstances an 8086 program tries to read or change the IF flag using the PUSHF or POPF </span>
<span id="t15_885" class="t s4_885">instructions, the processor will change the VIF flag instead, leaving IF unchanged. </span>
<span id="t16_885" class="t s4_885">The VIP flag provides software a means of recording the existence of a deferred (or pending) maskable hardware </span>
<span id="t17_885" class="t s4_885">interrupt. This flag is read by the processor but never explicitly written by the processor; it can only be written by </span>
<span id="t18_885" class="t s4_885">software. </span>
<span id="t19_885" class="t s4_885">If the IF flag is set and the VIF and VIP flags are enabled, and the processor receives a maskable hardware inter- </span>
<span id="t1a_885" class="t s4_885">rupt (interrupt vector 0 through 255), the processor performs and the interrupt handler software should perform </span>
<span id="t1b_885" class="t s4_885">the following operations: </span>
<span id="t1c_885" class="t s4_885">1. </span><span id="t1d_885" class="t s4_885">The processor invokes the protected-mode interrupt handler for the interrupt received, as described in the </span>
<span id="t1e_885" class="t s4_885">following steps. These steps are almost identical to those described for method 1 interrupt and exception </span>
<span id="t1f_885" class="t s4_885">handling in Section 21.3.1.1, “Handling an Interrupt or Exception Through a Protected-Mode Trap or Interrupt </span>
<span id="t1g_885" class="t s4_885">Gate”: </span>
<span id="t1h_885" class="t s4_885">a. </span><span id="t1i_885" class="t s4_885">Switches to 32-bit protected mode and privilege level 0. </span>
<span id="t1j_885" class="t s4_885">b. </span><span id="t1k_885" class="t s4_885">Saves the state of the processor on the privilege-level 0 stack. The states of the EIP, CS, EFLAGS, ESP, SS, </span>
<span id="t1l_885" class="t s4_885">ES, DS, FS, and GS registers are saved (see Figure 21-4). </span>
<span id="t1m_885" class="t s4_885">c. </span><span id="t1n_885" class="t s4_885">Clears the segment registers. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
