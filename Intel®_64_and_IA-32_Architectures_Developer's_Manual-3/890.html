<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p890" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_890{left:69px;bottom:68px;letter-spacing:0.12px;}
#t2_890{left:110px;bottom:68px;letter-spacing:0.1px;}
#t3_890{left:69px;bottom:1141px;letter-spacing:-0.15px;word-spacing:0.01px;}
#t4_890{left:69px;bottom:1088px;letter-spacing:-0.14px;word-spacing:-0.59px;}
#t5_890{left:69px;bottom:1071px;letter-spacing:-0.14px;word-spacing:-0.42px;}
#t6_890{left:69px;bottom:1054px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t7_890{left:69px;bottom:1037px;letter-spacing:-0.14px;word-spacing:-1.18px;}
#t8_890{left:69px;bottom:1020px;letter-spacing:-0.14px;word-spacing:-0.68px;}
#t9_890{left:69px;bottom:1004px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#ta_890{left:69px;bottom:987px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#tb_890{left:69px;bottom:919px;letter-spacing:0.15px;}
#tc_890{left:150px;bottom:919px;letter-spacing:0.21px;word-spacing:0.02px;}
#td_890{left:69px;bottom:894px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#te_890{left:69px;bottom:877px;letter-spacing:-0.15px;word-spacing:-1.38px;}
#tf_890{left:69px;bottom:860px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#tg_890{left:69px;bottom:843px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#th_890{left:69px;bottom:819px;letter-spacing:-0.13px;word-spacing:-0.47px;}
#ti_890{left:69px;bottom:802px;letter-spacing:-0.16px;word-spacing:-0.46px;}
#tj_890{left:69px;bottom:785px;letter-spacing:-0.14px;word-spacing:-1.28px;}
#tk_890{left:69px;bottom:768px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tl_890{left:69px;bottom:752px;letter-spacing:-0.14px;word-spacing:-1.03px;}
#tm_890{left:69px;bottom:735px;letter-spacing:-0.17px;word-spacing:-0.44px;}
#tn_890{left:69px;bottom:718px;letter-spacing:-0.15px;word-spacing:-1.21px;}
#to_890{left:69px;bottom:701px;letter-spacing:-0.14px;word-spacing:-1.24px;}
#tp_890{left:69px;bottom:684px;letter-spacing:-0.15px;word-spacing:-1.16px;}
#tq_890{left:69px;bottom:668px;letter-spacing:-0.16px;word-spacing:-0.77px;}
#tr_890{left:69px;bottom:651px;letter-spacing:-0.13px;word-spacing:-1.26px;}
#ts_890{left:69px;bottom:634px;letter-spacing:-0.14px;word-spacing:-1.26px;}
#tt_890{left:69px;bottom:617px;letter-spacing:-0.14px;word-spacing:-0.9px;}
#tu_890{left:69px;bottom:600px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tv_890{left:69px;bottom:576px;letter-spacing:-0.13px;word-spacing:-1.23px;}
#tw_890{left:69px;bottom:559px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#tx_890{left:69px;bottom:535px;letter-spacing:-0.14px;word-spacing:-0.45px;}
#ty_890{left:69px;bottom:518px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tz_890{left:69px;bottom:501px;letter-spacing:-0.17px;word-spacing:-0.42px;}
#t10_890{left:69px;bottom:477px;letter-spacing:-0.13px;word-spacing:-0.85px;}
#t11_890{left:69px;bottom:460px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#t12_890{left:69px;bottom:443px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#t13_890{left:69px;bottom:426px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#t14_890{left:69px;bottom:402px;letter-spacing:-0.23px;word-spacing:-0.39px;}
#t15_890{left:69px;bottom:385px;letter-spacing:-0.13px;word-spacing:-0.48px;}
#t16_890{left:69px;bottom:360px;letter-spacing:-0.13px;word-spacing:-0.51px;}
#t17_890{left:69px;bottom:344px;letter-spacing:-0.14px;word-spacing:-1.15px;}
#t18_890{left:69px;bottom:327px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t19_890{left:69px;bottom:310px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t1a_890{left:69px;bottom:293px;letter-spacing:-0.13px;word-spacing:-0.65px;}
#t1b_890{left:69px;bottom:276px;letter-spacing:-0.17px;word-spacing:-0.87px;}
#t1c_890{left:69px;bottom:260px;letter-spacing:-0.14px;word-spacing:-0.47px;}

.s1_890{font-size:12px;font-family:NeoSansIntel_1uk1;color:#000;}
.s2_890{font-size:14px;font-family:NeoSansIntel_1uk1;color:#0860A8;}
.s3_890{font-size:14px;font-family:Verdana_3e8;color:#000;}
.s4_890{font-size:21px;font-family:NeoSansIntelMedium_1uk0;color:#0860A8;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts890" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_1uk0;
	src: url("fonts/NeoSansIntelMedium_1uk0.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_1uk1;
	src: url("fonts/NeoSansIntel_1uk1.woff") format("woff");
}

@font-face {
	font-family: Verdana_3e8;
	src: url("fonts/Verdana_3e8.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg890Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg890" style="-webkit-user-select: none;"><object width="935" height="1210" data="890/890.svg" type="image/svg+xml" id="pdf890" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_890" class="t s1_890">21-20 </span><span id="t2_890" class="t s1_890">Vol. 3B </span>
<span id="t3_890" class="t s2_890">8086 EMULATION </span>
<span id="t4_890" class="t s3_890">Method 6 differs from method 5 in that with the IOPL value set to less than 3, the VIF and VIP flags in the EFLAGS </span>
<span id="t5_890" class="t s3_890">register are enabled, providing virtual interrupt support for handling class 2 maskable hardware interrupts (see </span>
<span id="t6_890" class="t s3_890">Section 21.3.2, “Class 2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the Virtual Interrupt </span>
<span id="t7_890" class="t s3_890">Mechanism”). These flags provide the virtual-8086 monitor with an efficient means of handling maskable hardware </span>
<span id="t8_890" class="t s3_890">interrupts that occur during a virtual-8086 mode task. Also, because the IOPL value is less than 3 and the VIF flag </span>
<span id="t9_890" class="t s3_890">is enabled, the information pushed on the stack by the processor when invoking the interrupt handler is slightly </span>
<span id="ta_890" class="t s3_890">different between methods 5 and 6 (see Table 21-2). </span>
<span id="tb_890" class="t s4_890">21.4 </span><span id="tc_890" class="t s4_890">PROTECTED-MODE VIRTUAL INTERRUPTS </span>
<span id="td_890" class="t s3_890">The IA-32 processors (beginning with the Pentium processor) also support the VIF and VIP flags in the EFLAGS </span>
<span id="te_890" class="t s3_890">register in protected mode by setting the PVI (protected-mode virtual interrupt) flag in the CR4 register. Setting the </span>
<span id="tf_890" class="t s3_890">PVI flag allows applications running at privilege level 3 to execute the CLI and STI instructions without causing a </span>
<span id="tg_890" class="t s3_890">general-protection exception (#GP) or affecting hardware interrupts. </span>
<span id="th_890" class="t s3_890">When the PVI flag is set to 1, the CPL is 3, and the IOPL is less than 3, the STI and CLI instructions set and clear </span>
<span id="ti_890" class="t s3_890">the VIF flag in the EFLAGS register, leaving IF unaffected. In this mode of operation, an application running in </span>
<span id="tj_890" class="t s3_890">protected mode and at a CPL of 3 can inhibit interrupts in the same manner as is described in Section 21.3.2, “Class </span>
<span id="tk_890" class="t s3_890">2—Maskable Hardware Interrupt Handling in Virtual-8086 Mode Using the Virtual Interrupt Mechanism,” for a </span>
<span id="tl_890" class="t s3_890">virtual-8086 mode task. When the application executes the CLI instruction, the processor clears the VIF flag. If the </span>
<span id="tm_890" class="t s3_890">processor receives a maskable hardware interrupt, the processor invokes the protected-mode interrupt handler. </span>
<span id="tn_890" class="t s3_890">This handler checks the state of the VIF flag in the EFLAGS register. If the VIF flag is clear (indicating that the active </span>
<span id="to_890" class="t s3_890">task does not want to have interrupts handled now), the handler sets the VIP flag in the EFLAGS image on the stack </span>
<span id="tp_890" class="t s3_890">and returns to the privilege-level 3 application, which continues program execution. When the application executes </span>
<span id="tq_890" class="t s3_890">a STI instruction to set the VIF flag, the processor automatically invokes the general-protection exception handler, </span>
<span id="tr_890" class="t s3_890">which can then handle the pending interrupt. After handing the pending interrupt, the handler typically sets the VIF </span>
<span id="ts_890" class="t s3_890">flag and clears the VIP flag in the EFLAGS image on the stack and executes a return to the application program. The </span>
<span id="tt_890" class="t s3_890">next time the processor receives a maskable hardware interrupt, the processor will handle it in the normal manner </span>
<span id="tu_890" class="t s3_890">for interrupts received while the processor is operating at a CPL of 3. </span>
<span id="tv_890" class="t s3_890">If the protected-mode virtual interrupt extension is enabled, CPL = 3, and the processor finds that both the VIF and </span>
<span id="tw_890" class="t s3_890">VIP flags are set at the beginning of an instruction, a general-protection exception is generated. </span>
<span id="tx_890" class="t s3_890">Because the protected-mode virtual interrupt extension changes only the treatment of EFLAGS.IF (by having CLI </span>
<span id="ty_890" class="t s3_890">and STI update EFLAGS.VIF instead), it affects only the masking of maskable hardware interrupts (interrupt </span>
<span id="tz_890" class="t s3_890">vectors 32 through 255). NMI interrupts and exceptions are handled in the normal manner. </span>
<span id="t10_890" class="t s3_890">(When protected-mode virtual interrupts are disabled (that is, when the PVI flag in control register CR4 is set to 0, </span>
<span id="t11_890" class="t s3_890">the CPL is less than 3, or the IOPL value is 3), then the CLI and STI instructions execute in a manner compatible </span>
<span id="t12_890" class="t s3_890">with the Intel486 processor. That is, if the CPL is greater (less privileged) than the I/O privilege level (IOPL), a </span>
<span id="t13_890" class="t s3_890">general-protection exception occurs. If the IOPL value is 3, CLI and STI clear or set the IF flag, respectively.) </span>
<span id="t14_890" class="t s3_890">PUSHF, POPF, IRET, and INT are executed like in the Intel486 processor, regardless of whether protected-mode </span>
<span id="t15_890" class="t s3_890">virtual interrupts are enabled. </span>
<span id="t16_890" class="t s3_890">It is only possible to enter virtual-8086 mode through a task switch or the execution of an IRET instruction, and it </span>
<span id="t17_890" class="t s3_890">is only possible to leave virtual-8086 mode by faulting to a protected-mode interrupt handler (typically the general- </span>
<span id="t18_890" class="t s3_890">protection exception handler, which in turn calls the virtual 8086-mode monitor). In both cases, the EFLAGS </span>
<span id="t19_890" class="t s3_890">register is saved and restored. This is not true, however, in protected mode when the PVI flag is set and the </span>
<span id="t1a_890" class="t s3_890">processor is not in virtual-8086 mode. Here, it is possible to call a procedure at a different privilege level, in which </span>
<span id="t1b_890" class="t s3_890">case the EFLAGS register is not saved or modified. However, the states of VIF and VIP flags are never examined by </span>
<span id="t1c_890" class="t s3_890">the processor when the CPL is not 3. </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
