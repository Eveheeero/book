<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta charset="utf-8" />
</head>

<body style="margin: 0;">

<div id="p1484" style="overflow: hidden; position: relative; background-color: white; width: 935px; height: 1210px;">

<!-- Begin shared CSS values -->
<style class="shared-css" type="text/css" >
.t {
	transform-origin: bottom left;
	z-index: 2;
	position: absolute;
	white-space: pre;
	overflow: visible;
	line-height: 1.5;
}
.text-container {
	white-space: pre;
}
@supports (-webkit-touch-callout: none) {
	.text-container {
		white-space: normal;
	}
}
</style>
<!-- End shared CSS values -->


<!-- Begin inline CSS -->
<style type="text/css" >

#t1_1484{left:69px;bottom:68px;letter-spacing:0.11px;}
#t2_1484{left:103px;bottom:68px;letter-spacing:0.09px;}
#t3_1484{left:69px;bottom:1141px;letter-spacing:-0.14px;}
#t4_1484{left:69px;bottom:1083px;letter-spacing:0.13px;}
#t5_1484{left:151px;bottom:1083px;letter-spacing:0.15px;word-spacing:0.01px;}
#t6_1484{left:69px;bottom:1060px;letter-spacing:-0.14px;word-spacing:-0.77px;}
#t7_1484{left:69px;bottom:1043px;letter-spacing:-0.16px;word-spacing:-0.45px;}
#t8_1484{left:69px;bottom:1027px;letter-spacing:-0.15px;word-spacing:-0.98px;}
#t9_1484{left:69px;bottom:1010px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#ta_1484{left:69px;bottom:993px;letter-spacing:-0.19px;word-spacing:-0.43px;}
#tb_1484{left:69px;bottom:970px;letter-spacing:-0.15px;word-spacing:-0.48px;}
#tc_1484{left:69px;bottom:953px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#td_1484{left:69px;bottom:936px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#te_1484{left:69px;bottom:878px;letter-spacing:0.13px;}
#tf_1484{left:151px;bottom:878px;letter-spacing:0.15px;word-spacing:0.01px;}
#tg_1484{left:69px;bottom:855px;letter-spacing:-0.14px;word-spacing:-1px;}
#th_1484{left:69px;bottom:839px;letter-spacing:-0.14px;word-spacing:-0.43px;}
#ti_1484{left:69px;bottom:816px;letter-spacing:-0.14px;word-spacing:-0.49px;}
#tj_1484{left:69px;bottom:799px;letter-spacing:-0.17px;}
#tk_1484{left:69px;bottom:740px;letter-spacing:0.13px;}
#tl_1484{left:151px;bottom:740px;letter-spacing:0.15px;word-spacing:0.01px;}
#tm_1484{left:69px;bottom:718px;letter-spacing:-0.14px;word-spacing:-0.64px;}
#tn_1484{left:69px;bottom:701px;letter-spacing:-0.16px;word-spacing:-0.45px;}
#to_1484{left:69px;bottom:684px;letter-spacing:-0.14px;word-spacing:-1.28px;}
#tp_1484{left:69px;bottom:668px;letter-spacing:-0.16px;}
#tq_1484{left:69px;bottom:645px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#tr_1484{left:69px;bottom:628px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#ts_1484{left:69px;bottom:611px;letter-spacing:-0.15px;word-spacing:-0.81px;}
#tt_1484{left:69px;bottom:594px;letter-spacing:-0.13px;word-spacing:-0.49px;}
#tu_1484{left:69px;bottom:571px;letter-spacing:-0.15px;word-spacing:-0.46px;}
#tv_1484{left:69px;bottom:554px;letter-spacing:-0.14px;word-spacing:-0.47px;}
#tw_1484{left:69px;bottom:538px;letter-spacing:-0.18px;word-spacing:-0.43px;}
#tx_1484{left:69px;bottom:521px;letter-spacing:-0.14px;word-spacing:-0.48px;}
#ty_1484{left:69px;bottom:504px;letter-spacing:-0.15px;word-spacing:-0.47px;}
#tz_1484{left:69px;bottom:487px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#t10_1484{left:69px;bottom:464px;letter-spacing:-0.14px;word-spacing:-0.91px;}
#t11_1484{left:69px;bottom:448px;letter-spacing:-0.14px;word-spacing:-0.46px;}
#t12_1484{left:69px;bottom:431px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#t13_1484{left:69px;bottom:414px;letter-spacing:-0.16px;word-spacing:-0.45px;}
#t14_1484{left:69px;bottom:397px;letter-spacing:-0.18px;word-spacing:-0.45px;}
#t15_1484{left:69px;bottom:374px;letter-spacing:-0.15px;word-spacing:-0.5px;}
#t16_1484{left:69px;bottom:357px;letter-spacing:-0.16px;word-spacing:-0.46px;}
#t17_1484{left:69px;bottom:341px;letter-spacing:-0.15px;word-spacing:-0.47px;}
#t18_1484{left:69px;bottom:324px;letter-spacing:-0.18px;word-spacing:-0.42px;}
#t19_1484{left:69px;bottom:301px;letter-spacing:-0.15px;word-spacing:-0.79px;}
#t1a_1484{left:69px;bottom:284px;letter-spacing:-0.17px;word-spacing:-0.43px;}
#t1b_1484{left:69px;bottom:225px;letter-spacing:0.13px;}
#t1c_1484{left:151px;bottom:225px;letter-spacing:0.16px;}
#t1d_1484{left:69px;bottom:203px;letter-spacing:-0.14px;word-spacing:-1.16px;}
#t1e_1484{left:69px;bottom:186px;letter-spacing:-0.16px;word-spacing:-0.44px;}
#t1f_1484{left:69px;bottom:169px;letter-spacing:-0.15px;word-spacing:-0.48px;}
#t1g_1484{left:69px;bottom:153px;letter-spacing:-0.15px;word-spacing:-0.45px;}
#t1h_1484{left:69px;bottom:130px;letter-spacing:-0.17px;word-spacing:-0.86px;}
#t1i_1484{left:69px;bottom:113px;letter-spacing:-0.14px;word-spacing:-1.14px;}

.s1_1484{font-size:12px;font-family:NeoSansIntel_1uk1;color:#000;}
.s2_1484{font-size:14px;font-family:NeoSansIntel_1uk1;color:#0860A8;}
.s3_1484{font-size:18px;font-family:NeoSansIntelMedium_1uk0;color:#0860A8;}
.s4_1484{font-size:14px;font-family:Verdana_3e8;color:#000;}
</style>
<!-- End inline CSS -->

<!-- Begin embedded font definitions -->
<style id="fonts1484" type="text/css" >

@font-face {
	font-family: NeoSansIntelMedium_1uk0;
	src: url("fonts/NeoSansIntelMedium_1uk0.woff") format("woff");
}

@font-face {
	font-family: NeoSansIntel_1uk1;
	src: url("fonts/NeoSansIntel_1uk1.woff") format("woff");
}

@font-face {
	font-family: Verdana_3e8;
	src: url("fonts/Verdana_3e8.woff") format("woff");
}

</style>
<!-- End embedded font definitions -->

<!-- Begin page background -->
<div id="pg1484Overlay" style="width:100%; height:100%; position:absolute; z-index:1; background-color:rgba(0,0,0,0); -webkit-user-select: none;"></div>
<div id="pg1484" style="-webkit-user-select: none;"><object width="935" height="1210" data="1484/1484.svg" type="image/svg+xml" id="pdf1484" style="width:935px; height:1210px; -moz-transform:scale(1); z-index: 0;"></object></div>
<!-- End page background -->


<!-- Begin text definitions (Positioned/styled in CSS) -->
<div class="text-container"><span id="t1_1484" class="t s1_1484">40-8 </span><span id="t2_1484" class="t s1_1484">Vol. 3D </span>
<span id="t3_1484" class="t s2_1484">ENCLAVE CODE DEBUG AND PROFILING </span>
<span id="t4_1484" class="t s3_1484">40.6.3 </span><span id="t5_1484" class="t s3_1484">Performance Monitoring with Opt-out Entry </span>
<span id="t6_1484" class="t s4_1484">In general, performance monitoring activities are suppressed when entering an opt-out enclave. This applies to all </span>
<span id="t7_1484" class="t s4_1484">thread-specific, configured performance monitoring, except for the cycle-counting fixed counter, </span>
<span id="t8_1484" class="t s4_1484">IA32_FIXED_CTR1 and IA32_FIXED_CTR2. Upon entering an opt-out enclave, IA32_FIXED_CTR0, IA32_PMCx will </span>
<span id="t9_1484" class="t s4_1484">stop accumulating counts. Additionally, if PEBS is configured to capture PEBS record for this thread, PEBS record </span>
<span id="ta_1484" class="t s4_1484">generation will also be suppressed. Consequently, bit 60 of IA32_PERF_GLOBAL_STATUS MSR is set. </span>
<span id="tb_1484" class="t s4_1484">Performance monitoring on the sibling thread may also be affected. Any one of IA32_FIXED_CTRx or IA32_PMCx </span>
<span id="tc_1484" class="t s4_1484">on the sibling thread configured to monitor thread-specific eventing logic with AnyThread =1 is demoted to count </span>
<span id="td_1484" class="t s4_1484">only MyThread while an opt-out enclave is executing on the other thread. </span>
<span id="te_1484" class="t s3_1484">40.6.4 </span><span id="tf_1484" class="t s3_1484">Enclave Exit and Performance Monitoring </span>
<span id="tg_1484" class="t s4_1484">When a logical processor exits an enclave, either via ENCLU[EEXIT] or via AEX, all performance monitoring activity </span>
<span id="th_1484" class="t s4_1484">(including PEBS) on that logical processor that was suppressed is unsuppressed. </span>
<span id="ti_1484" class="t s4_1484">Any counters that were demoted from AnyThread to MyThread on the sibling thread are promoted back to </span>
<span id="tj_1484" class="t s4_1484">AnyThread. </span>
<span id="tk_1484" class="t s3_1484">40.6.5 </span><span id="tl_1484" class="t s3_1484">PEBS Record Generation on Intel® SGX Instructions </span>
<span id="tm_1484" class="t s4_1484">All leaf functions of the ENCLS instruction report “Eventing RIP” of the ENCLS instruction if a PEBS record is gener- </span>
<span id="tn_1484" class="t s4_1484">ated at the end of the instruction execution. Additionally, the EGETKEY and EREPORT leaf functions of the ENCLU </span>
<span id="to_1484" class="t s4_1484">instruction report “Eventing RIP” of the ENCLU instruction if a PEBS record is generated at the end of the instruction </span>
<span id="tp_1484" class="t s4_1484">execution. </span>
<span id="tq_1484" class="t s4_1484">If the EENTER and ERESUME leaf functions are performing an opt-in entry report “Eventing RIP” of the ENCLU </span>
<span id="tr_1484" class="t s4_1484">instruction if a PEBS record is generated at the end of the instruction execution. On the other hand, if these leaf </span>
<span id="ts_1484" class="t s4_1484">functions are performing an opt-out entry, then these leaf functions result in PEBS being suppressed, and no PEBS </span>
<span id="tt_1484" class="t s4_1484">record is generated at the end of these instructions. </span>
<span id="tu_1484" class="t s4_1484">A PEBS record is generated if there is a PEBS event pending at the end of EEXIT (due to a counter overflowing </span>
<span id="tv_1484" class="t s4_1484">during enclave execution or during EEXIT execution). This PEBS record contains the architectural state of the </span>
<span id="tw_1484" class="t s4_1484">logical processor at the end of EEXIT. If the enclave was entered via an opt-in entry, then this record reports the </span>
<span id="tx_1484" class="t s4_1484">“Eventing RIP” as the linear address of the ENCLU[EEXIT] instruction. If the enclave was entered via an opt-out </span>
<span id="ty_1484" class="t s4_1484">entry, then the record reports the “Eventing RIP” as the linear address of the ENCLU[EENTER/ERESUME] instruc- </span>
<span id="tz_1484" class="t s4_1484">tion that performed the last enclave entry. </span>
<span id="t10_1484" class="t s4_1484">A PEBS record is generated after the AEX if there is a PEBS event pending at the end of AEX (due to a counter over- </span>
<span id="t11_1484" class="t s4_1484">flowing during enclave execution or during AEX execution). This PEBS record contains the synthetic state of the </span>
<span id="t12_1484" class="t s4_1484">logical processor that is established at the end of AEX. For opt-in entry, this record has the EVENTING_RIP set to </span>
<span id="t13_1484" class="t s4_1484">the RIP saved in the SSA. For opt-out entry, the record has the EVENTING_RIP set to the linear address of </span>
<span id="t14_1484" class="t s4_1484">EENTER/ERESUME used for the last enclave entry. </span>
<span id="t15_1484" class="t s4_1484">If the enclave was entered via an opt-in entry, then this record reports the “Eventing RIP” as the linear address in </span>
<span id="t16_1484" class="t s4_1484">the SSA of the enclave (a.k.a., the “Eventing LIP” inside the enclave). If the enclave was entered via an opt-out </span>
<span id="t17_1484" class="t s4_1484">entry, then the record reports the “Eventing RIP” as the linear address of the ENCLU[EENTER/ERESUME] instruc- </span>
<span id="t18_1484" class="t s4_1484">tion that performed the last enclave entry. </span>
<span id="t19_1484" class="t s4_1484">A second PEBS event may be pended during the Enclave Exiting Event (EEE). If the PEBS event is taken at the end </span>
<span id="t1a_1484" class="t s4_1484">of delivery of the EEE then the “Eventing RIP” in this second PEBS record is the linear address of the AEP. </span>
<span id="t1b_1484" class="t s3_1484">40.6.6 </span><span id="t1c_1484" class="t s3_1484">Exception-Handling on PEBS/BTS Loads/Stores after AEX </span>
<span id="t1d_1484" class="t s4_1484">As noted in Section 18.4.9.2, recording in the BTS buffer or in the PEBS buffer may not operate properly if accesses </span>
<span id="t1e_1484" class="t s4_1484">to any of the DS save area sections cause page faults or VM exits. Such page faults or VM exits, if they occur, are </span>
<span id="t1f_1484" class="t s4_1484">delivered immediately to the OS or VMM, and generation of a BTS or PEBS record is skipped and may leave the </span>
<span id="t1g_1484" class="t s4_1484">buffers in a state where they have a partial BTS or PEBS records. </span>
<span id="t1h_1484" class="t s4_1484">However, any events that are detected during PEBS/BTS record generation at the end of AEX and before delivering </span>
<span id="t1i_1484" class="t s4_1484">the Enclave Exiting Event (EEE) cannot be reported immediately to the OS/VMM, as an event window is not open at </span></div>
<!-- End text definitions -->


</div>
</body>
</html>
